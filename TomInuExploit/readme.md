# Uniswap | WETH-TINU exploit

## Information:
- Total lost: 22 ETH
- Attacker: [0x14d8ada7a0ba91f59dc0cb97c8f44f1d177c2195](https://etherscan.io/address/0x14d8ada7a0ba91f59dc0cb97c8f44f1d177c2195)
- Attack Contract: [0xdb2d869ac23715af204093e933f5eb57f2dc12a9](https://etherscan.io/address/0xdb2d869ac23715af204093e933f5eb57f2dc12a9)
- Vulnerable Contract (TomInu): [0x2d0e64b6bf13660a4c0de42a0b88144a7c10991f](https://etherscan.io/address/0x2d0e64b6bf13660a4c0de42a0b88144a7c10991f)
- Attack Tx:
    - Blocksec: [0x6200bf5c43c214caa1177c3676293442059b4f39eb5dbae6cfd4e6ad16305668](https://phalcon.blocksec.com/tx/eth/0x6200bf5c43c214caa1177c3676293442059b4f39eb5dbae6cfd4e6ad16305668)
    - Etherscan: [0x6200bf5c43c214caa1177c3676293442059b4f39eb5dbae6cfd4e6ad16305668](https://etherscan.io/tx/0x6200bf5c43c214caa1177c3676293442059b4f39eb5dbae6cfd4e6ad16305668)
- Reproduce using Foundry: [TINU_exp.t.sol](https://github.com/SunWeb3Sec/DeFiHackLabs/blob/main/src/test/TINU_exp.t.sol)


## Vulnerable code explain

### ***balanceOf***

For non-excluded account, following steps are taken to calculate balance:
- Contract calculates current supply (rSupply, tSupply) by subtracting the balances of rOwned and tOwned of all the excluded addresses from rTotal and tTotal, respectively.
- If ratio of rTotal and tTotal is:
    - Greater than current calculated rSupply, returns rTotal and tTotal
    - If not greater than, then returns current calculated rSupply and tSupply
- Using above values (rSupply, tSupply), rate is calculated: rSupply/tSupply
- Then, users balance gets divided by this rate, called as reflectionBalance, which balanceOf method returns.



```bash
function balanceOf(address account) public view override returns (uint256) {
    if (_isExcluded[account]) return _tOwned[account];
    return tokenFromReflection(_rOwned[account]);
}
function tokenFromReflection(uint256 rAmount) public view returns(uint256) {
   require(rAmount <= _rTotal, "Amount must be less than total reflections");
   uint256 currentRate =  _getRate();
   return rAmount.div(currentRate);
}
function _getRate() private view returns(uint256) {
   (uint256 rSupply, uint256 tSupply) = _getCurrentSupply();
   return rSupply.div(tSupply);
}
function _getCurrentSupply() private view returns(uint256, uint256) {
   uint256 rSupply = _rTotal;
   uint256 tSupply = _tTotal;      
   for (uint256 i = 0; i < _excluded.length; i++) {
       if (_rOwned[_excluded[i]] > rSupply || _tOwned[_excluded[i]] > tSupply) return (_rTotal, _tTotal);
       rSupply = rSupply.sub(_rOwned[_excluded[i]]);
       tSupply = tSupply.sub(_tOwned[_excluded[i]]);
   }
   if (rSupply < _rTotal.div(_tTotal)) return (_rTotal, _tTotal);
   return (rSupply, tSupply);
}
```

### ***deliver***

- Calculates rAmount, which is the supplied amount (tAmount) multiplied by the rate (described at ***balanceOf*** :point_up_2: )
- Deductes this rAmount from sender’s rOwned amount
- Deductes this rAmount from rTotal
- Adds the supplied amount (tAmount) to total fee, tFeeTotal
- Due to these changes rTotal gets changed,which affects the current rate as well, which is used in the calculation of balanceOf() method


```bash
function deliver(uint256 tAmount) public {
   address sender = _msgSender();
   require(!_isExcluded[sender], "Excluded addresses cannot call this function");
   (uint256 rAmount,,,,,) = _getValues(tAmount);
   _rOwned[sender] = _rOwned[sender].sub(rAmount);
   _rTotal = _rTotal.sub(rAmount);
   _tFeeTotal = _tFeeTotal.add(tAmount);
 }
function _getValues(uint256 tAmount) private view returns (uint256, uint256, uint256, uint256, uint256, uint256) {
    (uint256 tTransferAmount, uint256 tFee, uint256 tteam) = _getTValues(tAmount, _taxFee, _teamFee);
    uint256 currentRate =  _getRate();
    (uint256 rAmount, uint256 rTransferAmount, uint256 rFee) = _getRValues(tAmount, tFee, currentRate);
    return (rAmount, rTransferAmount, rFee, tTransferAmount, tFee, tteam);
}
function _getRValues(uint256 tAmount, uint256 tFee, uint256 currentRate) private pure returns (uint256, uint256, uint256) {
    uint256 rAmount = tAmount.mul(currentRate);
    uint256 rFee = tFee.mul(currentRate);
    uint256 rTransferAmount = rAmount.sub(rFee);
    return (rAmount, rTransferAmount, rFee);
}
function _getRate() private view returns(uint256) {
    (uint256 rSupply, uint256 tSupply) = _getCurrentSupply();
    return rSupply.div(tSupply);
}
```

### ***skim***

Uniswap V2's skim method lets anyone claim a positive discrepancy between the actual token balance in the contract and the reserve number stored in the Pair contract.

```bash
// force balances to match reserves
function skim(address to) external lock {
    address _token0 = token0; // gas savings
    address _token1 = token1; // gas savings
    _safeTransfer(_token0, to, IERC20(_token0).balanceOf(address(this)).sub(reserve0));
    _safeTransfer(_token1, to, IERC20(_token1).balanceOf(address(this)).sub(reserve1));
}

```

## Steps

---
### Alias
- Attack contract -> aContract
- Attacker -> aUser
- Vulnerable contract -> vContract or TINU
- Uniswap v2 router 02 -> uniR2
- Uniswap V2 -> uniV2
- Balance Vault -> bVault
---

1. aContract checked WETH balance of bVault: 139039.729301264180297254 WETH
2. aContract flash loaned all WETH balance of bVault: 139039.729301264180297254 WETH
3. bVault executes `receiveFlashLoan` method of its own:
    - aContract approves 104.850000000000000000 WETH to uniR2
    - aContract executes `swapExactTokensForTokensSupportingFeeOnTransferTokens` method of uniR2 to swap 104.850000000000000000 WETH for any amount of TINU
        - uniR2 fetches 104.850000000000000000 WETH from aContract
        - uniR2 checks aContract’s TINU balance, which is zero (0)
        - uniV2 checks WETH-TINU pair reserves: WETH: 22.144561461014981232, TINU: 1781945970074.638149262
        - uniV2 checks WETH-TINU pair WETH balance: 126.994561461014981232 WETH
        - uniV2 call `swap` to transfer 1470449218539.614064547 TINU (amountOut Tokens) to aContract
            - Now TINU is a reflective token, means it incentivize the holder (in this case uniV2), {see [***balanceOf***](#balanceof)}
            - Total TINU transferred to aContract: 1352813281056.444939385
            - Total fee deducted in this transfer: ~117635937483.00 TINU
            - TINU balance of uniV2: 316871513264.115731249 TINU
            - Current reserve of uniV2: WETH: 126.994561461014981232, TINU: 316871513264.115731249
            - aContract balance TINU: 1465904852700.232013011
    - aContract executes `deliver` method of TINU, explain this method: {see [***deliver***](#deliver)}
        - Following above method calls, the balance returned by balanceOf method differs from actual amount transferred.
    - aContract executes `skim` method os uniV2
        - After swap is executed, all the reserves are updated. So, before this skim method call, aContract called `deliver` method which basically changed the currentRate TINU. Here, in `skim` method, if there’s difference in the reserves and balanceOf the same contract, then it transfers the remaining amount to the caller (aContract in this case) {see [***skim***](#skim)}
        - As per above explanation, uniV2 execute `transfer` of TINU for amount 1733770910894.426471783
        - After fee deduction, aContract receives 1595069238022.872354042 TINU, fee deducted ~138701672872.00 TINU
        - uniV2 also execute `transfer` method of WETH with zero (0) amount, as per the skim process
    - aContract TINU balance is 1733769909104.888397946
    - aContract executes `deliver` method of TINU with amount 1733769909104.888397946
    - uniV2 WETH balance at this stage: 126.994561461014981232
    - aContract executes `swap` method of uniV2 for 126.990751624171150782 WETH exactly. Leaving 0.0038098368 WETH in uniV2:
        - uniV2 transfers 126.990751624171150782 WETH to aContract
        - uniV2 transferFrom’s aContract 11191538443606951.933168556 TINU
        - Sync reserve: WETH: 0.003809836843830450,  TINU: 11191855315120216.048899805
4. aContract transfers flash loaned amount bVault: 139.039729301264180297254 WETH
5. aContract executes `withdraw` method of WETH for 22.140751624171150782 ETH
6. aContract transfers 0.03 ETH to Flashbots: Builder, bVault called the `receiveFlashLoan` method, under which flashbot deducted some fees. This ensures Tx is not visible in the memepool and is directly sent to the miner.
7. aContract self destructs, and aUser receives 22.110751624171150782 ETH

## Problem with TomInu
`deliver` method of TINU, changes the rTotal value which is basically used to calculate the current rate, and this rate is used in calculation of `balanceOf` method. So after first swap, the reserves are updated, and then attacker called `deliver` method to change this current rate.
Attacker then called `skim` method and due to the change in current rate, the `balanceOf` method return larger value than the updated reserve value, and from here, remaining amount of TINU transferred to attacker.
